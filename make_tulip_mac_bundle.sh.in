#!/bin/sh

# This script is MAC specific, it intents to create an internet deliverable
# disk image of a tulip MAC 'bundle' in the current directory
APP_DIR=Tulip-@PACKAGE_VERSION@.app

if [ -d $APP_DIR ]; then
  rm -rf $APP_DIR
fi

BIN_BUNDLE_DIR=$APP_DIR/Contents/MacOS
BIN_BUNDLE=$BIN_BUNDLE_DIR/tulip
LIBS_BUNDLE_DIR=$APP_DIR/Contents/Frameworks
RESOURCES_BUNDLE_DIR=$APP_DIR/Contents/Resources

# copy the tulip binary
echo installing $BIN_BUNDLE
cp -R @prefix@/bin/tulip.app .
mv tulip.app $APP_DIR
# add icons file
echo installing $RESOURCES_BUNDLE_DIR/tulip.icns
mkdir -p $RESOURCES_BUNDLE_DIR
cp tulip_mac.icns $RESOURCES_BUNDLE_DIR/tulip.icns
# add Info.plist file
cp Info.plist $APP_DIR/Contents

# create the shared libs bundle directory
mkdir -p $LIBS_BUNDLE_DIR
# look for shared libs
SHARED_LIBS=`otool -L $BIN_BUNDLE | grep dylib | awk '{print $1}'`
# copy libs in shared libs bundle directory
for LIB in $SHARED_LIBS
do
  OLDLIB=$LIB
  if [ "$LIB" = "*System*" ]; then
   continue
  fi 
  if [ "$LIB" = "*/libSystem*.dylib" ]; then
   continue
  fi 
  if [ ! -f $LIB ]; then
    LIB=/usr/lib/$LIB
  fi
  if [ -f $LIB ]; then
    cp $LIB $LIBS_BUNDLE_DIR
    LIB=`basename $LIB`
    echo installing $LIBS_BUNDLE_DIR/$LIB
    # install the current bundle lib
    install_name_tool -id @executable_path/../Frameworks/$LIB $LIBS_BUNDLE_DIR/$LIB
    # install tulip bundle binary with the current bundle lib
    install_name_tool -change $OLDLIB @executable_path/../Frameworks/$LIB $BIN_BUNDLE
  else
    echo `basename $LIB` not found... exiting
  fi
done

# copy bitmaps and plugins in lib bundle dir
TLP_PLUGINS_BUNDLE_DIR=$APP_DIR/Contents/lib/tlp
mkdir -p $APP_DIR/Contents/lib
echo installing $TLP_PLUGINS_BUNDLE_DIR
cp -R @prefix@/lib/tlp $APP_DIR/Contents/lib

# copy Qt assistant application
ASSISTANT_BUNDLE_DIR=$APP_DIR/Contents/assistant.app
ASSISTANT_LIBS_BUNDLE_DIR=$ASSISTANT_BUNDLE_DIR/Contents/Frameworks
ASSISTANT_BIN_BUNDLE=$ASSISTANT_BUNDLE_DIR/Contents/MacOS/assistant
echo installing $ASSISTANT_BUNDLE_DIR
cp -R @QTDIR@/bin/assistant.app $APP_DIR/Contents
mkdir $ASSISTANT_LIBS_BUNDLE_DIR
# update assistant binary and libs
SHARED_LIBS=`otool -L $ASSISTANT_BIN_BUNDLE | grep dylib | awk '{print $1}'`
# copy libs in shared libs bundle directory
for LIB in $SHARED_LIBS
do
  OLDLIB=$LIB
  if [ "$LIB" = "*System*" ]; then
   continue
  fi 
  if [ "$LIB" = "*/libSystem*.dylib" ]; then
   continue
  fi 
  if [ ! -f $LIB ]; then
    LIB=/usr/lib/$LIB
  fi
  if [ -f $LIB ]; then
    cp $LIB $ASSISTANT_LIBS_BUNDLE_DIR
    LIB=`basename $LIB`
    echo installing $ASSISTANT_LIBS_BUNDLE_DIR/$LIB
    # install the current bundle lib
    install_name_tool -id @executable_path/../Frameworks/$LIB $ASSISTANT_LIBS_BUNDLE_DIR/$LIB
    # install tulip bundle binary with the current bundle lib
    install_name_tool -change $OLDLIB @executable_path/../Frameworks/$LIB $ASSISTANT_BIN_BUNDLE
  else
    echo `basename $LIB` not found... exiting
  fi
done

# copy tulip docs
echo installing $APP_DIR/Contents/share/tulip
mkdir -p $APP_DIR/Contents/share/tulip
cp -R @prefix@/share/tulip/* $APP_DIR/Contents/share/tulip
 
# create disk image with our bundle
echo creating Tulip-@PACKAGE_VERSION@.dmg disk image
hdiutil create -srcdir $APP_DIR -format UDZO -fs HFS+ -volname Tulip-@PACKAGE_VERSION@ -ov Tulip-@PACKAGE_VERSION@.dmg
# then internet enabled it
hdiutil internet-enable -yes tulip-@PACKAGE_VERSION@.dmg
